<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Multiplayer Bingo Online</title>
<style>
  :root{
    --bg:#ffffff; --card:#ffffff; --ink:#111; --muted:#6b7280;
    --line:#e5e7eb; --line2:#d1d5db; --btn:#2563eb; --btnTxt:#fff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:980px;margin:24px auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px;box-shadow:0 6px 24px rgba(0,0,0,.06)}
  h1{margin:4px 0 14px;font-weight:800;text-align:center;font-size:32px;
     background:linear-gradient(90deg,#2563eb,#7c3aed);-webkit-background-clip:text;background-clip:text;color:transparent}
  .center{display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .hidden{display:none !important}

  button{border:1px solid var(--line2);background:#f8fafc;border-radius:10px;padding:10px 14px;
         cursor:pointer;font-weight:700;color:#111}
  button.primary{background:var(--btn);border-color:var(--btn);color:var(--btnTxt)}
  button:disabled{opacity:.6;cursor:not-allowed}
  input[type=text]{width:100%;border:1px solid var(--line2);border-radius:10px;padding:10px;background:#fff;color:#111}

  /* Banner BINGO */
  .bingo-banner{margin:2px auto 10px;display:flex;justify-content:center;gap:10px;letter-spacing:6px}
  .bingo-letter{font-size:40px;font-weight:900;opacity:.28}
  .bingo-letter.hit{opacity:1;transform:scale(1.06);transition:.2s ease}

  /* Board */
  .board{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin:10px auto 6px;max-width:360px}
  .cell{aspect-ratio:1/1;border-radius:50%;display:flex;align-items:center;justify-content:center;
        background:#ffffff;border:1px solid var(--line2);color:#111;font-weight:800;font-size:16px;user-select:none;cursor:pointer}
  .cell input{width:100%;height:100%;border:0;background:transparent;text-align:center;color:#111;font-weight:800;font-size:16px;border-radius:50%}
  .cell.struck{color:#111}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line2);border-radius:999px;padding:6px 12px;background:#fff}
  .dot{width:12px;height:12px;border-radius:50%}
  .title{font-weight:800;margin:2px 0 4px}
  .hr{height:1px;background:var(--line);margin:14px 0;border-radius:1px}
  .mini{font-size:12px;color:var(--muted)}

  .winners{border:1px solid var(--line2);border-radius:10px;padding:10px 12px;background:#fff}
  .glow{box-shadow:0 0 0 0 rgba(37,99,235,.6);animation:glow 1.2s ease-in-out infinite}
  @keyframes glow{50%{box-shadow:0 0 0 12px rgba(37,99,235,0)}}

  /* Winner toast + confetti */
  .toast{
    position:fixed; top:-200px; left:0; right:0; z-index:9999;
    display:flex; justify-content:center; pointer-events:none;
  }
  .toast-inner{
    background:#ffffff; border:1px solid var(--line2); border-radius:12px;
    padding:12px 16px; margin-top:12px; box-shadow:0 12px 30px rgba(0,0,0,.12);
    font-weight:800; color:#111; display:flex; align-items:center; gap:10px;
  }
  .toast.show{animation:slideDown .5s ease forwards}
  .toast.hide{animation:slideUp .4s ease forwards}
  @keyframes slideDown{from{top:-200px;opacity:.2}to{top:0;opacity:1}}
  @keyframes slideUp{from{top:0;opacity:1}to{top:-200px;opacity:0}}

  .confetti{
    position:fixed; top:-20px; left:0; width:100%; height:0; pointer-events:none; overflow:visible; z-index:9998;
  }
  .confetti i{
    position:absolute; top:-20px; width:8px; height:12px; opacity:.95; transform:rotate(0deg);
    animation:fall 1.6s linear forwards;
    border-radius:2px;
  }
  @keyframes fall{
    to{ transform:translateY(220px) rotate(180deg); opacity:.9; }
  }
</style>
</head>
<body>
<div class="toast" id="toast">
  <div class="toast-inner" id="toastText">ðŸŽ‰ Player won!</div>
</div>
<div class="confetti" id="confetti"></div>

<div class="wrap">
  <div class="card">

    <h1>Multiplayer Bingo Online</h1>

    <!-- Big colorful BINGO -->
    <div id="banner" class="bingo-banner hidden">
      <span class="bingo-letter" id="L0" style="color:#ef4444">B</span>
      <span class="bingo-letter" id="L1" style="color:#f59e0b">I</span>
      <span class="bingo-letter" id="L2" style="color:#10b981">N</span>
      <span class="bingo-letter" id="L3" style="color:#3b82f6">G</span>
      <span class="bingo-letter" id="L4" style="color:#a855f7">O</span>
    </div>

    <!-- Choose -->
    <div id="step-choose" class="center" style="margin:8px 0 6px">
      <button id="btnCreate" class="primary">Create Room</button>
      <button id="btnJoin">Join Room</button>
    </div>

    <!-- Create -->
    <div id="step-create" class="section hidden">
      <div class="row">
        <div>
          <div class="title">Your Nickname</div>
          <input id="createName" type="text" placeholder="e.g., Vasanth"/>
        </div>
        <div>
          <div class="title">Room Code</div>
          <input id="createCode" type="text" readonly/>
        </div>
      </div>
      <div class="center" style="margin-top:8px">
        <button id="createGo" class="primary">Create & Enter Lobby</button>
        <button id="back1">Back</button>
      </div>
    </div>

    <!-- Join -->
    <div id="step-join" class="section hidden">
      <div class="row">
        <div>
          <div class="title">Your Nickname</div>
          <input id="joinName" type="text" placeholder="e.g., Arjun"/>
        </div>
        <div>
          <div class="title">Room Code</div>
          <input id="joinCode" type="text" placeholder="ABCDE"/>
        </div>
      </div>
      <div class="center" style="margin-top:8px">
        <button id="joinGo" class="primary">Join Lobby</button>
        <button id="back2">Back</button>
      </div>
    </div>

    <!-- Lobby -->
    <div id="step-lobby" class="hidden">
      <div class="pill" style="margin-bottom:8px">
        <span class="mini">Room</span>&nbsp;<b id="roomCodeLabel"></b>
      </div>

      <div class="title">Players</div>
      <div id="players" class="center" style="margin-bottom:6px"></div>

      <div class="hr"></div>

      <div class="title">Your Board</div>
      <div class="center">
        <button id="autoFill">Auto Fill 1â€“25</button>
        <button id="manualFill">Manual Entry</button>
      </div>
      <div id="boardBuilder" class="board" style="margin-top:8px"></div>
      <div class="center">
        <button id="readyBtn" class="primary hidden">Iâ€™m Ready</button>
      </div>

      <div class="hr"></div>
      <div class="center">
        <button id="startBtn" class="primary glow hidden">Start Game</button>
      </div>
      <div class="mini center" style="margin-top:2px">Anyone can start after <b>everyone</b> is ready.</div>
    </div>

    <!-- Game -->
    <div id="step-game" class="hidden">
      <div class="center" style="margin-bottom:6px">
        <div class="pill"><span class="mini">Turn:</span>&nbsp;<b id="turnName">-</b></div>
        <div class="pill"><span class="mini">You:</span>&nbsp;<span id="youDot" class="dot"></span>&nbsp;<b id="youName"></b></div>
      </div>
      <div id="gameBoard" class="board"></div>

      <div id="winnersBox" class="winners hidden" style="margin-top:10px">
        <div class="title">Winners</div>
        <ol id="winnerList" style="margin:6px 0 0 20px"></ol>
      </div>
    </div>

  </div>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<script>
/* ============ 1) Firebase Config (replace) ============ */
const firebaseConfig = {
  apiKey: "AIzaSyDY9AUUyco-stWWr3HxZ4VYDASN5JQHlAY",
  authDomain: "bingogame-ea6c9.firebaseapp.com",
  databaseURL: "https://bingogame-ea6c9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "bingogame-ea6c9",
  storageBucket: "bingogame-ea6c9.firebasestorage.app",
  messagingSenderId: "553263162615",
  appId: "1:553263162615:web:b20e3feb6d282a3f3b9ff2",
  measurementId: "G-ED0490QCMN"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ============ 2) State ============ */
const PASTEL = ["#ff6b6b","#60a5fa","#34d399","#fbbf24","#a78bfa","#22d3ee","#f472b6","#86efac"];
let my = { pid:null, name:"", color:"", room:"", board:[], ready:false };
let players = {};             // pid -> data
let order = [];               // join order
let numbersStruck = {};       // num -> pid
let currentTurnIndex = 0;
let winnersObj = {};          // pid -> {name,rank}
let gameOver = false;
let seenWinnerPids = new Set(); // toasts only once per winner

/* ============ 3) Helpers ============ */
const $ = id => document.getElementById(id);
const show = id => $(id).classList.remove("hidden");
const hide = id => $(id).classList.add("hidden");
const code = ()=>Math.random().toString(36).substring(2,7).toUpperCase();

function toRGBA(hex, a=0.28){
  const h = hex.replace("#","");
  const r=parseInt(h.slice(0,2),16), g=parseInt(h.slice(2,4),16), b=parseInt(h.slice(4,6),16);
  return `rgba(${r},${g},${b},${a})`;
}
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
function linesFromBoard(b){
  const rows = [0,1,2,3,4].map(r=>b.slice(r*5, r*5+5));
  const cols = [0,1,2,3,4].map(c=>[b[c],b[c+5],b[c+10],b[c+15],b[c+20]]);
  const d1 = [b[0],b[6],b[12],b[18],b[24]];
  const d2 = [b[4],b[8],b[12],b[16],b[20]];
  return [...rows, ...cols, d1, d2];
}

/* ===== winner toast & confetti ===== */
function showWinnerToast(text){
  const toast = $("toast");
  const tx = $("toastText");
  tx.textContent = text;
  toast.classList.remove("hide");
  toast.classList.add("show");
  makeConfetti();
  setTimeout(()=>{
    toast.classList.remove("show");
    toast.classList.add("hide");
  }, 2200);
}
function makeConfetti(){
  const c = $("confetti"); c.innerHTML = "";
  const colors = ["#ef4444","#f59e0b","#10b981","#3b82f6","#a855f7","#22d3ee"];
  for(let i=0;i<60;i++){
    const piece = document.createElement("i");
    piece.style.left = Math.random()*100 + "%";
    piece.style.background = colors[i%colors.length];
    piece.style.animationDelay = (Math.random()*0.6)+"s";
    piece.style.transform = `translateY(0) rotate(${Math.random()*180}deg)`;
    c.appendChild(piece);
  }
}

/* ============ 4) UI Nav ============ */
$("btnCreate").onclick = ()=>{ hide("step-choose"); show("step-create"); $("createCode").value = code(); };
$("btnJoin").onclick   = ()=>{ hide("step-choose"); show("step-join"); };
$("back1").onclick = ()=>{ hide("step-create"); show("step-choose"); };
$("back2").onclick = ()=>{ hide("step-join"); show("step-choose"); };

/* ============ 5) Create / Join ============ */
$("createGo").onclick = async ()=>{
  const nickname = $("createName").value.trim();
  const room = $("createCode").value.trim().toUpperCase();
  if(!nickname || !room) return alert("Enter nickname and room code.");
  my = { pid:"p"+Date.now(), name:nickname, color:PASTEL[0], room, board:[], ready:false };
  await db.ref(`rooms/${room}`).set({ createdAt:Date.now(), started:false, currentTurn:0, order:[my.pid], nextRank:1, gameOver:false });
  await db.ref(`rooms/${room}/players/${my.pid}`).set({ nickname, color:my.color, ready:false, board:[], rank:null, finished:false, bingoCount:0 });
  enterLobby();
};

$("joinGo").onclick = async ()=>{
  const nickname = $("joinName").value.trim();
  const room = $("joinCode").value.trim().toUpperCase();
  if(!nickname || !room) return alert("Enter nickname and room code.");
  const r = db.ref(`rooms/${room}`); const s = await r.get();
  if(!s.exists()) return alert("Room not found.");
  const orderSnap = await db.ref(`rooms/${room}/order`).get();
  const ord = orderSnap.val() || [];
  my = { pid:"p"+Date.now(), name:nickname, color:PASTEL[ord.length % PASTEL.length], room, board:[], ready:false };
  await db.ref(`rooms/${room}/order`).set([...ord, my.pid]);
  await db.ref(`rooms/${room}/players/${my.pid}`).set({ nickname, color:my.color, ready:false, board:[], rank:null, finished:false, bingoCount:0 });
  enterLobby();
};

/* ============ 6) Lobby & Board setup ============ */
function enterLobby(){
  hide("step-create"); hide("step-join"); show("step-lobby");
  $("roomCodeLabel").textContent = my.room;

  db.ref(`rooms/${my.room}/players`).on("value", snap=>{
    players = snap.val() || {};
    renderPlayers(); updateStartVisibility();
  });
  db.ref(`rooms/${my.room}/order`).on("value", snap=>{
    order = snap.val() || [];
    renderPlayers(); updateStartVisibility();
  });
  db.ref(`rooms/${my.room}/started`).on("value", snap=>{
    if(snap.val()===true){ startGameUI(); }
  });

  $("boardBuilder").innerHTML = "";
  hide("readyBtn");
  $("autoFill").disabled = false; $("manualFill").disabled = false;
}

function renderPlayers(){
  const c = $("players"); c.innerHTML="";
  order.forEach(pid=>{
    const p = players[pid]; if(!p) return;
    const el = document.createElement("div");
    el.className="pill";
    el.innerHTML = `<span class="dot" style="background:${p.color}"></span><b>${p.nickname}</b>${p.ready?' <span class="mini" style="color:#10b981">&nbsp;READY</span>':' <span class="mini">&nbsp;not ready</span>'}`;
    c.appendChild(el);
  });
}
function updateStartVisibility(){
  const allReady = order.length>0 && order.every(pid=>players[pid]?.ready);
  if(allReady) show("startBtn"); else hide("startBtn");
}

$("autoFill").onclick = ()=>{
  my.board = shuffle(Array.from({length:25},(_,i)=>i+1));
  buildBoardInputs(my.board, true);
  show("readyBtn");
};
$("manualFill").onclick = ()=>{
  buildBoardInputs(Array(25).fill(""), false); // blank circles
  show("readyBtn");
};

function buildBoardInputs(vals, locked){
  const host = $("boardBuilder"); host.innerHTML = "";
  vals.forEach((v)=>{
    const cell = document.createElement("div"); cell.className="cell";
    if(locked){
      cell.textContent = v;
    }else{
      const input = document.createElement("input");
      input.type="text"; input.maxLength=2; input.placeholder="";
      input.oninput = ()=>{ input.value = input.value.replace(/[^0-9]/g,""); };
      cell.appendChild(input);
    }
    host.appendChild(cell);
  });
  $("autoFill").disabled = locked; $("manualFill").disabled = locked;
}

$("readyBtn").onclick = async ()=>{
  if(my.board.length!==25){
    const inputs = Array.from($("boardBuilder").querySelectorAll("input"));
    const vals = inputs.map(i=>parseInt(i.value,10));
    if(vals.some(v=>!Number.isInteger(v) || v<1 || v>25)) return alert("Enter numbers 1â€“25.");
    if(new Set(vals).size!==25) return alert("Numbers must be unique (1â€“25).");
    my.board = vals;
  }
  await db.ref(`rooms/${my.room}/players/${my.pid}/board`).set(my.board);
  await db.ref(`rooms/${my.room}/players/${my.pid}/ready`).set(true);
  $("readyBtn").textContent = "Ready âœ“"; $("readyBtn").disabled = true;
};

$("startBtn").onclick = async ()=>{
  const allReady = order.every(pid=>players[pid]?.ready);
  if(!allReady) return alert("All players must be ready.");
  await db.ref(`rooms/${my.room}/numbers/struck`).set(null);
  await db.ref(`rooms/${my.room}/winners`).set(null);
  await db.ref(`rooms/${my.room}/nextRank`).set(1);
  await db.ref(`rooms/${my.room}/gameOver`).set(false);
  await db.ref(`rooms/${my.room}/started`).set(true);
  await db.ref(`rooms/${my.room}/currentTurn`).set(0);
};

/* ============ 7) Game ============ */
function startGameUI(){
  hide("step-lobby"); show("step-game"); show("banner");
  $("youDot").style.background = my.color; $("youName").textContent = my.name;
  renderGameBoard();

  db.ref(`rooms/${my.room}/currentTurn`).on("value", s=>{
    currentTurnIndex = s.val() ?? 0;
    const pid = order[currentTurnIndex] || "";
    $("turnName").textContent = players[pid]?.nickname || "-";
  });
  db.ref(`rooms/${my.room}/numbers/struck`).on("value", async s=>{
    numbersStruck = s.val() || {};
    paintBoard();
    await autoCheckWinFromUpdate();      // if someone elseâ€™s click wins me, rank me now
  });
  db.ref(`rooms/${my.room}/winners`).on("value", s=>{
    const before = new Set(Object.keys(winnersObj||{}));
    winnersObj = s.val() || {};
    renderWinners();

    // detect new winners to toast
    const after = new Set(Object.keys(winnersObj));
    for(const pid of after){
      if(!before.has(pid) && !seenWinnerPids.has(pid)){
        const w = winnersObj[pid];
        const name = (players[pid]?.nickname || w.name || "A player");
        showWinnerToast(`ðŸŽ‰ ${name} got BINGO! Rank ${w.rank}`);
        seenWinnerPids.add(pid);
      }
    }

    // if exactly 2 players and at least 1 winner â†’ end and scroll
    if(order.length === 2 && Object.keys(winnersObj).length >= 1){
      db.ref(`rooms/${my.room}/gameOver`).set(true);
      setTimeout(()=>{ document.getElementById("winnersBox").scrollIntoView({behavior:"smooth", block:"start"}); }, 800);
    }
  });
  db.ref(`rooms/${my.room}/gameOver`).on("value", s=>{
    gameOver = !!s.val();
    if(gameOver){ disableBoard(); }
  });
}

function renderGameBoard(){
  const host = $("gameBoard"); host.innerHTML = "";
  my.board.forEach(num=>{
    const cell = document.createElement("div");
    cell.className="cell"; cell.dataset.num = num; cell.textContent = num;
    cell.onclick = ()=>tryStrike(num);
    host.appendChild(cell);
  });
  paintBoard();
}

function paintBoard(){
  const cells = Array.from($("gameBoard").children);
  cells.forEach(c=>{
    const num = parseInt(c.dataset.num,10);
    const striker = numbersStruck[num];
    if(striker){
      const color = players[striker]?.color || "#999";
      c.classList.add("struck");
      c.style.background = toRGBA(color, 0.28);
      c.style.borderColor = color;
    }else{
      c.classList.remove("struck");
      c.style.background = "#fff";
      c.style.borderColor = "#d1d5db";
    }
  });

  // update my banner letters
  const struck = new Set(Object.keys(numbersStruck).map(n=>parseInt(n,10)));
  const lines = linesFromBoard(my.board);
  let done = 0; lines.forEach(line=>{ if(line.every(n=>struck.has(n))) done++; });
  for(let i=0;i<5;i++){ const el=$("L"+i); if(i<done) el.classList.add("hit"); else el.classList.remove("hit"); }
  db.ref(`rooms/${my.room}/players/${my.pid}/bingoCount`).set(done);
}

function disableBoard(){
  Array.from($("gameBoard").children).forEach(c=>c.onclick=null);
}

/* skip finished players when advancing turn */
async function advanceTurn(){
  let idx = currentTurnIndex;
  const total = order.length;
  for(let tries=0; tries<total; tries++){
    idx = (idx+1) % total;
    const pid = order[idx];
    const pSnap = await db.ref(`rooms/${my.room}/players/${pid}/finished`).get();
    if(!pSnap.val()) { await db.ref(`rooms/${my.room}/currentTurn`).set(idx); return; }
  }
  // everyone finished â†’ end game
  await db.ref(`rooms/${my.room}/gameOver`).set(true);
}

async function tryStrike(num){
  if(gameOver) return;
  const myIndex = order.indexOf(my.pid);
  const meFinishedSnap = await db.ref(`rooms/${my.room}/players/${my.pid}/finished`).get();
  if(meFinishedSnap.val()) return;
  if(myIndex !== currentTurnIndex) return alert("Not your turn!");

  const ref = db.ref(`rooms/${my.room}/numbers/struck/${num}`);
  let assigned = false;
  await ref.transaction(current=>{
    if(current) return current;
    assigned = true;
    return my.pid;
  });
  if(!assigned) return;

  await handlePostStrikeLogic();
}

async function handlePostStrikeLogic(){
  await advanceTurn();
}

async function autoCheckWinFromUpdate(){
  if(gameOver) return;

  const struck = new Set(Object.keys(numbersStruck).map(n=>parseInt(n,10)));
  const lines = linesFromBoard(my.board);
  let done = 0; lines.forEach(line=>{ if(line.every(n=>struck.has(n))) done++; });

  const meRef = db.ref(`rooms/${my.room}/players/${my.pid}`);
  const meSnap = await meRef.get();
  const me = meSnap.val() || {};
  if(me.finished) return;

  if(done >= 5){
    // transactional, idempotent ranking
    const rankRef = db.ref(`rooms/${my.room}/nextRank`);
    let assigned;
    await rankRef.transaction(cur => { cur = cur || 1; assigned = cur; return cur + 1; });

    const existingRankSnap = await db.ref(`rooms/${my.room}/players/${my.pid}/rank`).get();
    if(!existingRankSnap.exists()){
      await db.ref(`rooms/${my.room}/players/${my.pid}`).update({ rank: assigned, finished: true });
      await db.ref(`rooms/${my.room}/winners/${my.pid}`).set({ name: my.name, rank: assigned });
    }

    // if exactly 2 players â†’ end game and scroll
    if(order.length === 2){
      await db.ref(`rooms/${my.room}/gameOver`).set(true);
      setTimeout(()=>{ document.getElementById("winnersBox").scrollIntoView({behavior:"smooth", block:"start"}); }, 800);
    }
  }

  // end if all finished
  const playersSnap = await db.ref(`rooms/${my.room}/players`).get();
  const data = playersSnap.val() || {};
  const finishedCount = Object.values(data).filter(p=>p.finished).length;
  if(finishedCount === Object.keys(data).length){
    await db.ref(`rooms/${my.room}/gameOver`).set(true);
  }
}

/* winners list */
function renderWinners(){
  const box = $("winnersBox");
  const list = $("winnerList"); list.innerHTML = "";
  const entries = Object.entries(winnersObj).map(([pid,v])=>({pid, ...v}));
  entries.sort((a,b)=>a.rank-b.rank);
  entries.forEach(w=>{
    const li = document.createElement("li");
    const color = players[w.pid]?.color || "#999";
    li.innerHTML = `<span class="dot" style="background:${color};display:inline-block;margin-right:8px"></span><b>${w.name}</b> â€” Rank ${w.rank}`;
    list.appendChild(li);
  });
  if(entries.length>0) show("winnersBox");
}
</script>
</body>
</html>
